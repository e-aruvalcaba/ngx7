/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable, Optional } from '@angular/core';
import { Http } from '@angular/http';
import { Subject } from 'rxjs';
import { Broadcaster } from '@cemex-core/events-v7';
export class TranslationService {
    /**
     * @param {?} eventBroadcaster
     * @param {?} http
     * @param {?} _productPath
     * @param {?} useTranslationServer
     * @param {?} _translationUrl
     */
    constructor(eventBroadcaster, http, _productPath, useTranslationServer, _translationUrl) {
        this.eventBroadcaster = eventBroadcaster;
        this.http = http;
        this._productPath = _productPath;
        this.useTranslationServer = useTranslationServer;
        this._translationUrl = _translationUrl;
        this._useTranslationServer = false;
        this.productPath = '';
        this._localeData = new Subject();
        this.productPath = _productPath || '/';
        this._useTranslationServer = useTranslationServer || false;
        if (this._translationUrl === null) {
            this._translationUrl = '/translate/translate';
        }
        if (this.isRunningOnBrowser()) {
            /** @type {?} */
            const comingFromReact = ((/** @type {?} */ (global))).sessionStorage.getItem('language') || 'en_US';
            /** @type {?} */
            let langLocalStorage = ((/** @type {?} */ (global))).localStorage.getItem('language');
            if (comingFromReact.indexOf('es') !== -1 && !this._useTranslationServer) {
                langLocalStorage = 'es';
                ((/** @type {?} */ (global))).localStorage.setItem('language', 'es');
            }
            else if (comingFromReact.indexOf('en') !== -1 &&
                !this._useTranslationServer) {
                langLocalStorage = 'en';
                ((/** @type {?} */ (global))).localStorage.setItem('language', 'en');
            }
            else {
                langLocalStorage = comingFromReact;
                ((/** @type {?} */ (global))).localStorage.setItem('language', langLocalStorage);
            }
            /** @type {?} */
            let localLang;
            if (this._useTranslationServer) {
                this.lang(langLocalStorage ? langLocalStorage : 'en_US');
                localLang = langLocalStorage ? langLocalStorage : 'en_US';
            }
            else {
                this.lang(langLocalStorage ? langLocalStorage : 'en');
                localLang = langLocalStorage ? langLocalStorage : 'en';
            }
            // add this next line to correct react projects
            if (localLang === 'en') {
                localLang = localLang + '_US';
            }
            else if (localLang === 'es') {
                localLang = localLang + '_MX';
            }
            ((/** @type {?} */ (global))).sessionStorage.setItem('language', localLang);
        }
        else {
            if (this._useTranslationServer) {
                this.lang('en_US');
            }
            else {
                this.lang('en');
            }
        }
    }
    /**
     * st comes from static-translation
     * @param {?} textID
     * @return {?}
     */
    static st(textID) {
        /** @type {?} */
        const textValue = this.translation.get(textID);
        if (!textValue || textValue === undefined) {
            return 'NOT:' + textID;
        }
        return textValue;
    }
    /**
     * gets all translations
     * @return {?}
     */
    static all() {
        /** @type {?} */
        const result = this.translation;
        return result;
    }
    /**
     * @return {?}
     */
    get localeData() {
        return this._localeData.asObservable();
    }
    /**
     * @return {?}
     */
    isRunningOnBrowser() {
        return ((/** @type {?} */ (global))) !== null && ((/** @type {?} */ (global))) !== undefined;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    onChange(value) {
        this.labels = value;
        this._localeData.next(value);
    }
    /**
     * this method is left here for backwards compatibility
     * @param {?} lang
     * @return {?}
     */
    lang(lang) {
        if (lang === TranslationService.language) {
            return;
        }
        TranslationService.language = lang;
        // add this next line to correct react projects, need to correct this
        /** @type {?} */
        let localLang = TranslationService.language;
        if (localLang === 'en') {
            localLang = localLang + '_US';
        }
        else if (localLang === 'es') {
            localLang = localLang + '_MX';
        }
        if (this.isRunningOnBrowser()) {
            sessionStorage.setItem('language', localLang);
        }
        // if the language is only 2 letters it might be a legacy application
        if (!this._useTranslationServer) {
            this.http
                .get(this.productPath + 'vendor/locale-' + lang + '.json')
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            response => this.populateTranslation(response.json())))
                .catch(this.handleError);
        }
        else {
            // if the translation name is bigger than 2 letters, request to external server
            this.http
                .get(this._translationUrl + this.productPath + localLang)
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            response => this.populateTranslation(response.json())))
                .catch(this.handleError);
        }
    }
    /**
     * @param {?} lang
     * @return {?}
     */
    isoLang(lang) {
        // must contain either one of these symbols
        if (lang.indexOf('-') !== -1 || lang.indexOf('_') !== -1) {
            TranslationService.language = lang;
            ((/** @type {?} */ (global))).sessionStorage.setItem('language', lang);
        }
    }
    /**
     * @param {?} url
     * @return {?}
     */
    file(url) {
        this.http
            .get(url)
            .toPromise()
            .then((/**
         * @param {?} response
         * @return {?}
         */
        response => this.populateTranslation(response.json())))
            .catch(this.handleError);
    }
    /**
     * pt comes from public-translation
     * @param {?} textID
     * @return {?}
     */
    pt(textID) {
        /** @type {?} */
        const textValue = TranslationService.translation.get(textID);
        if (!textValue || textValue === undefined) {
            return 'NOT:' + textID;
        }
        return textValue;
    }
    /**
     * @param {?} textId
     * @return {?}
     */
    getLabel(textId) {
        /** @type {?} */
        const textValue = TranslationService.translation.get(textId);
        if (!textValue) {
            return undefined;
        }
        return textValue;
    }
    /**
     * @return {?}
     */
    getlang() {
        return TranslationService.language;
    }
    /**
     * @return {?}
     */
    getCountryCode() {
        return TranslationService.language.split('_')[1];
    }
    /**
     * @param {?} result
     * @return {?}
     */
    populateTranslation(result) {
        for (const item of Object.keys(result)) {
            TranslationService.translation.set(item, result[item]);
        }
        this.eventBroadcaster.broadcast(Broadcaster.DCM_LANGUAGE_FETCHED, TranslationService.language);
        this.onChange(result);
    }
    /**
     * @param {?} error
     * @return {?}
     */
    handleError(error) {
        return Promise.reject(error.message || error);
    }
}
TranslationService.translation = new Map();
TranslationService.language = '';
// Must be set on path constants
TranslationService.PRODUCT_PATH = 'PRODUCT_PATH';
TranslationService.USE_TRANSLATION_SERVER = 'USE_TRANSLATION_SERVER';
TranslationService.TRANSLATION_BASE_URL = 'TRANSLATION_BASE_URL';
TranslationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
TranslationService.ctorParameters = () => [
    { type: Broadcaster },
    { type: Http },
    { type: String, decorators: [{ type: Inject, args: [TranslationService.PRODUCT_PATH,] }, { type: Optional }] },
    { type: Boolean, decorators: [{ type: Inject, args: [TranslationService.USE_TRANSLATION_SERVER,] }, { type: Optional }] },
    { type: String, decorators: [{ type: Inject, args: [TranslationService.TRANSLATION_BASE_URL,] }, { type: Optional }] }
];
if (false) {
    /** @type {?} */
    TranslationService.translation;
    /** @type {?} */
    TranslationService.language;
    /** @type {?} */
    TranslationService.PRODUCT_PATH;
    /** @type {?} */
    TranslationService.USE_TRANSLATION_SERVER;
    /** @type {?} */
    TranslationService.TRANSLATION_BASE_URL;
    /** @type {?} */
    TranslationService.prototype.labels;
    /** @type {?} */
    TranslationService.prototype._useTranslationServer;
    /** @type {?} */
    TranslationService.prototype.productPath;
    /** @type {?} */
    TranslationService.prototype._localeData;
    /** @type {?} */
    TranslationService.prototype.eventBroadcaster;
    /** @type {?} */
    TranslationService.prototype.http;
    /** @type {?} */
    TranslationService.prototype._productPath;
    /** @type {?} */
    TranslationService.prototype.useTranslationServer;
    /** @type {?} */
    TranslationService.prototype._translationUrl;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjZW1leC1jb3JlL2FuZ3VsYXItc2VydmljZXMtdjcvIiwic291cmNlcyI6WyJsaWIvdHJhbnNsYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLcEQsTUFBTSxPQUFPLGtCQUFrQjs7Ozs7Ozs7SUFrQzdCLFlBQ1MsZ0JBQTZCLEVBQzdCLElBQVUsRUFHVixZQUFvQixFQUdwQixvQkFBNkIsRUFHN0IsZUFBdUI7UUFWdkIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFhO1FBQzdCLFNBQUksR0FBSixJQUFJLENBQU07UUFHVixpQkFBWSxHQUFaLFlBQVksQ0FBUTtRQUdwQix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQVM7UUFHN0Isb0JBQWUsR0FBZixlQUFlLENBQVE7UUFuQ3pCLDBCQUFxQixHQUFHLEtBQUssQ0FBQztRQUU5QixnQkFBVyxHQUFHLEVBQUUsQ0FBQztRQUNqQixnQkFBVyxHQUFpQixJQUFJLE9BQU8sRUFBTyxDQUFDO1FBa0NwRCxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQVksSUFBSSxHQUFHLENBQUM7UUFDdkMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLG9CQUFvQixJQUFJLEtBQUssQ0FBQztRQUUzRCxJQUFJLElBQUksQ0FBQyxlQUFlLEtBQUssSUFBSSxFQUFFO1lBQ2pDLElBQUksQ0FBQyxlQUFlLEdBQUcsc0JBQXNCLENBQUM7U0FDL0M7UUFFRCxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxFQUFF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QUF6TWEsOEJBQVcsR0FBd0IsSUFBSSxHQUFHLEVBQWtCLENBQUM7QUFDN0QsMkJBQVEsR0FBRyxFQUFFLENBQUM7O0FBR2QsK0JBQVksR0FBRyxjQUFjLENBQUM7QUFDOUIseUNBQXNCLEdBQUcsd0JBQXdCLENBQUM7QUFDbEQsdUNBQW9CLEdBQUcsc0JBQXNCLENBQUM7O1lBUjdELFVBQVU7Ozs7WUFKRixXQUFXO1lBSlgsSUFBSTt5Q0E4Q1IsTUFBTSxTQUFDLGtCQUFrQixDQUFDLFlBQVksY0FDdEMsUUFBUTswQ0FFUixNQUFNLFNBQUMsa0JBQWtCLENBQUMsc0JBQXNCLGNBQ2hELFFBQVE7eUNBRVIsTUFBTSxTQUFDLGtCQUFrQixDQUFDLG9CQUFvQixjQUM5QyxRQUFROzs7O0lBM0NYLCtCQUEyRTs7SUFDM0UsNEJBQTRCOztJQUc1QixnQ0FBNEM7O0lBQzVDLDBDQUFnRTs7SUFDaEUsd0NBQTREOztJQUU1RCxvQ0FBbUI7O0lBQ25CLG1EQUFxQzs7SUFFckMseUNBQXdCOztJQUN4Qix5Q0FBc0Q7O0lBc0JwRCw4Q0FBb0M7O0lBQ3BDLGtDQUFpQjs7SUFDakIsMENBRTJCOztJQUMzQixrREFFb0M7O0lBQ3BDLDZDQUU4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHAgfSBmcm9tICdAYW5ndWxhci9odHRwJztcblxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBCcm9hZGNhc3RlciB9IGZyb20gJ0BjZW1leC1jb3JlL2V2ZW50cy12Nyc7XG5cbmRlY2xhcmUgdmFyIGdsb2JhbDogYW55O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVHJhbnNsYXRpb25TZXJ2aWNlIHtcbiAgcHVibGljIHN0YXRpYyB0cmFuc2xhdGlvbjogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gIHB1YmxpYyBzdGF0aWMgbGFuZ3VhZ2UgPSAnJztcbiAgLy8gTXVzdCBiZSBzZXQgb24gcGF0aCBjb25zdGFudHNcblxuICBwdWJsaWMgc3RhdGljIFBST0RVQ1RfUEFUSCA9ICdQUk9EVUNUX1BBVEgnO1xuICBwdWJsaWMgc3RhdGljIFVTRV9UUkFOU0xBVElPTl9TRVJWRVIgPSAnVVNFX1RSQU5TTEFUSU9OX1NFUlZFUic7XG4gIHB1YmxpYyBzdGF0aWMgVFJBTlNMQVRJT05fQkFTRV9VUkwgPSAnVFJBTlNMQVRJT05fQkFTRV9VUkwnO1xuXG4gIHB1YmxpYyBsYWJlbHM6IGFueTtcbiAgcHVibGljIF91c2VUcmFuc2xhdGlvblNlcnZlciA9IGZhbHNlO1xuXG4gIHB1YmxpYyBwcm9kdWN0UGF0aCA9ICcnO1xuICBwdWJsaWMgX2xvY2FsZURhdGE6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICAvKipcbiAgICogc3QgY29tZXMgZnJvbSBzdGF0aWMtdHJhbnNsYXRpb25cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgc3QodGV4dElEOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHRleHRWYWx1ZSA9IHRoaXMudHJhbnNsYXRpb24uZ2V0KHRleHRJRCk7XG4gICAgaWYgKCF0ZXh0VmFsdWUgfHwgdGV4dFZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiAnTk9UOicgKyB0ZXh0SUQ7XG4gICAgfVxuICAgIHJldHVybiB0ZXh0VmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogZ2V0cyBhbGwgdHJhbnNsYXRpb25zXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGFsbCgpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLnRyYW5zbGF0aW9uO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgZXZlbnRCcm9hZGNhc3RlcjogQnJvYWRjYXN0ZXIsXG4gICAgcHVibGljIGh0dHA6IEh0dHAsXG4gICAgQEluamVjdChUcmFuc2xhdGlvblNlcnZpY2UuUFJPRFVDVF9QQVRIKVxuICAgIEBPcHRpb25hbCgpXG4gICAgcHVibGljIF9wcm9kdWN0UGF0aDogc3RyaW5nLFxuICAgIEBJbmplY3QoVHJhbnNsYXRpb25TZXJ2aWNlLlVTRV9UUkFOU0xBVElPTl9TRVJWRVIpXG4gICAgQE9wdGlvbmFsKClcbiAgICBwdWJsaWMgdXNlVHJhbnNsYXRpb25TZXJ2ZXI6IGJvb2xlYW4sXG4gICAgQEluamVjdChUcmFuc2xhdGlvblNlcnZpY2UuVFJBTlNMQVRJT05fQkFTRV9VUkwpXG4gICAgQE9wdGlvbmFsKClcbiAgICBwdWJsaWMgX3RyYW5zbGF0aW9uVXJsOiBzdHJpbmdcbiAgKSB7XG4gICAgdGhpcy5wcm9kdWN0UGF0aCA9IF9wcm9kdWN0UGF0aCB8fCAnLyc7XG4gICAgdGhpcy5fdXNlVHJhbnNsYXRpb25TZXJ2ZXIgPSB1c2VUcmFuc2xhdGlvblNlcnZlciB8fCBmYWxzZTtcblxuICAgIGlmICh0aGlzLl90cmFuc2xhdGlvblVybCA9PT0gbnVsbCkge1xuICAgICAgdGhpcy5fdHJhbnNsYXRpb25VcmwgPSAnL3RyYW5zbGF0ZS90cmFuc2xhdGUnO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzUnVubmluZ09uQnJvd3NlcigpKSB7XG4gICAgICBjb25zdCBjb21pbmdGcm9tUmVhY3QgPVxuICAgICAgICAoZ2xvYmFsIGFzIGFueSkuc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2UnKSB8fCAnZW5fVVMnO1xuICAgICAgbGV0IGxhbmdMb2NhbFN0b3JhZ2UgPSAoZ2xvYmFsIGFzIGFueSkubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlJyk7XG4gICAgICBpZiAoY29taW5nRnJvbVJlYWN0LmluZGV4T2YoJ2VzJykgIT09IC0xICYmICF0aGlzLl91c2VUcmFuc2xhdGlvblNlcnZlcikge1xuICAgICAgICBsYW5nTG9jYWxTdG9yYWdlID0gJ2VzJztcbiAgICAgICAgKGdsb2JhbCBhcyBhbnkpLmxvY2FsU3RvcmFnZS5zZXRJdGVtKCdsYW5ndWFnZScsICdlcycpO1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgY29taW5nRnJvbVJlYWN0LmluZGV4T2YoJ2VuJykgIT09IC0xICYmXG4gICAgICAgICF0aGlzLl91c2VUcmFuc2xhdGlvblNlcnZlclxuICAgICAgKSB7XG4gICAgICAgIGxhbmdMb2NhbFN0b3JhZ2UgPSAnZW4nO1xuICAgICAgICAoZ2xvYmFsIGFzIGFueSkubG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2xhbmd1YWdlJywgJ2VuJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsYW5nTG9jYWxTdG9yYWdlID0gY29taW5nRnJvbVJlYWN0O1xuICAgICAgICAoZ2xvYmFsIGFzIGFueSkubG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2xhbmd1YWdlJywgbGFuZ0xvY2FsU3RvcmFnZSk7XG4gICAgICB9XG4gICAgICBsZXQgbG9jYWxMYW5nOiBzdHJpbmc7XG4gICAgICBpZiAodGhpcy5fdXNlVHJhbnNsYXRpb25TZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy5sYW5nKGxhbmdMb2NhbFN0b3JhZ2UgPyBsYW5nTG9jYWxTdG9yYWdlIDogJ2VuX1VTJyk7XG4gICAgICAgIGxvY2FsTGFuZyA9IGxhbmdMb2NhbFN0b3JhZ2UgPyBsYW5nTG9jYWxTdG9yYWdlIDogJ2VuX1VTJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubGFuZyhsYW5nTG9jYWxTdG9yYWdlID8gbGFuZ0xvY2FsU3RvcmFnZSA6ICdlbicpO1xuICAgICAgICBsb2NhbExhbmcgPSBsYW5nTG9jYWxTdG9yYWdlID8gbGFuZ0xvY2FsU3RvcmFnZSA6ICdlbic7XG4gICAgICB9XG5cbiAgICAgIC8vIGFkZCB0aGlzIG5leHQgbGluZSB0byBjb3JyZWN0IHJlYWN0IHByb2plY3RzXG5cbiAgICAgIGlmIChsb2NhbExhbmcgPT09ICdlbicpIHtcbiAgICAgICAgbG9jYWxMYW5nID0gbG9jYWxMYW5nICsgJ19VUyc7XG4gICAgICB9IGVsc2UgaWYgKGxvY2FsTGFuZyA9PT0gJ2VzJykge1xuICAgICAgICBsb2NhbExhbmcgPSBsb2NhbExhbmcgKyAnX01YJztcbiAgICAgIH1cbiAgICAgIChnbG9iYWwgYXMgYW55KS5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdsYW5ndWFnZScsIGxvY2FsTGFuZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLl91c2VUcmFuc2xhdGlvblNlcnZlcikge1xuICAgICAgICB0aGlzLmxhbmcoJ2VuX1VTJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmxhbmcoJ2VuJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdldCBsb2NhbGVEYXRhKCkge1xuICAgIHJldHVybiB0aGlzLl9sb2NhbGVEYXRhLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIGlzUnVubmluZ09uQnJvd3NlcigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKGdsb2JhbCBhcyBhbnkpICE9PSBudWxsICYmIChnbG9iYWwgYXMgYW55KSAhPT0gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHVibGljIG9uQ2hhbmdlKHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmxhYmVscyA9IHZhbHVlO1xuICAgIHRoaXMuX2xvY2FsZURhdGEubmV4dCh2YWx1ZSk7XG4gIH1cblxuICAvKipcbiAgICogdGhpcyBtZXRob2QgaXMgbGVmdCBoZXJlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eVxuICAgKi9cbiAgcHVibGljIGxhbmcobGFuZzogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGxhbmcgPT09IFRyYW5zbGF0aW9uU2VydmljZS5sYW5ndWFnZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBUcmFuc2xhdGlvblNlcnZpY2UubGFuZ3VhZ2UgPSBsYW5nO1xuICAgIC8vIGFkZCB0aGlzIG5leHQgbGluZSB0byBjb3JyZWN0IHJlYWN0IHByb2plY3RzLCBuZWVkIHRvIGNvcnJlY3QgdGhpc1xuICAgIGxldCBsb2NhbExhbmc6IHN0cmluZyA9IFRyYW5zbGF0aW9uU2VydmljZS5sYW5ndWFnZTtcbiAgICBpZiAobG9jYWxMYW5nID09PSAnZW4nKSB7XG4gICAgICBsb2NhbExhbmcgPSBsb2NhbExhbmcgKyAnX1VTJztcbiAgICB9IGVsc2UgaWYgKGxvY2FsTGFuZyA9PT0gJ2VzJykge1xuICAgICAgbG9jYWxMYW5nID0gbG9jYWxMYW5nICsgJ19NWCc7XG4gICAgfVxuICAgIGlmICh0aGlzLmlzUnVubmluZ09uQnJvd3NlcigpKSB7XG4gICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdsYW5ndWFnZScsIGxvY2FsTGFuZyk7XG4gICAgfVxuICAgIC8vIGlmIHRoZSBsYW5ndWFnZSBpcyBvbmx5IDIgbGV0dGVycyBpdCBtaWdodCBiZSBhIGxlZ2FjeSBhcHBsaWNhdGlvblxuICAgIGlmICghdGhpcy5fdXNlVHJhbnNsYXRpb25TZXJ2ZXIpIHtcbiAgICAgIHRoaXMuaHR0cFxuICAgICAgICAuZ2V0KHRoaXMucHJvZHVjdFBhdGggKyAndmVuZG9yL2xvY2FsZS0nICsgbGFuZyArICcuanNvbicpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB0aGlzLnBvcHVsYXRlVHJhbnNsYXRpb24ocmVzcG9uc2UuanNvbigpKSlcbiAgICAgICAgLmNhdGNoKHRoaXMuaGFuZGxlRXJyb3IpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBpZiB0aGUgdHJhbnNsYXRpb24gbmFtZSBpcyBiaWdnZXIgdGhhbiAyIGxldHRlcnMsIHJlcXVlc3QgdG8gZXh0ZXJuYWwgc2VydmVyXG4gICAgICB0aGlzLmh0dHBcbiAgICAgICAgLmdldCh0aGlzLl90cmFuc2xhdGlvblVybCArIHRoaXMucHJvZHVjdFBhdGggKyBsb2NhbExhbmcpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB0aGlzLnBvcHVsYXRlVHJhbnNsYXRpb24ocmVzcG9uc2UuanNvbigpKSlcbiAgICAgICAgLmNhdGNoKHRoaXMuaGFuZGxlRXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpc29MYW5nKGxhbmc6IHN0cmluZyk6IHZvaWQge1xuICAgIC8vIG11c3QgY29udGFpbiBlaXRoZXIgb25lIG9mIHRoZXNlIHN5bWJvbHNcbiAgICBpZiAobGFuZy5pbmRleE9mKCctJykgIT09IC0xIHx8IGxhbmcuaW5kZXhPZignXycpICE9PSAtMSkge1xuICAgICAgVHJhbnNsYXRpb25TZXJ2aWNlLmxhbmd1YWdlID0gbGFuZztcbiAgICAgIChnbG9iYWwgYXMgYW55KS5zZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdsYW5ndWFnZScsIGxhbmcpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBmaWxlKHVybDogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5odHRwXG4gICAgICAuZ2V0KHVybClcbiAgICAgIC50b1Byb21pc2UoKVxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gdGhpcy5wb3B1bGF0ZVRyYW5zbGF0aW9uKHJlc3BvbnNlLmpzb24oKSkpXG4gICAgICAuY2F0Y2godGhpcy5oYW5kbGVFcnJvcik7XG4gIH1cblxuICAvKipcbiAgICogcHQgY29tZXMgZnJvbSBwdWJsaWMtdHJhbnNsYXRpb25cbiAgICovXG4gIHB1YmxpYyBwdCh0ZXh0SUQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgdGV4dFZhbHVlID0gVHJhbnNsYXRpb25TZXJ2aWNlLnRyYW5zbGF0aW9uLmdldCh0ZXh0SUQpO1xuICAgIGlmICghdGV4dFZhbHVlIHx8IHRleHRWYWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gJ05PVDonICsgdGV4dElEO1xuICAgIH1cblxuICAgIHJldHVybiB0ZXh0VmFsdWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0TGFiZWwodGV4dElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHRleHRWYWx1ZSA9IFRyYW5zbGF0aW9uU2VydmljZS50cmFuc2xhdGlvbi5nZXQodGV4dElkKTtcbiAgICBpZiAoIXRleHRWYWx1ZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHRleHRWYWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRsYW5nKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFRyYW5zbGF0aW9uU2VydmljZS5sYW5ndWFnZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRDb3VudHJ5Q29kZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBUcmFuc2xhdGlvblNlcnZpY2UubGFuZ3VhZ2Uuc3BsaXQoJ18nKVsxXTtcbiAgfVxuXG4gIHB1YmxpYyBwb3B1bGF0ZVRyYW5zbGF0aW9uKHJlc3VsdCkge1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBPYmplY3Qua2V5cyhyZXN1bHQpKSB7XG4gICAgICBUcmFuc2xhdGlvblNlcnZpY2UudHJhbnNsYXRpb24uc2V0KGl0ZW0sIHJlc3VsdFtpdGVtXSk7XG4gICAgfVxuICAgIHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3QoXG4gICAgICBCcm9hZGNhc3Rlci5EQ01fTEFOR1VBR0VfRkVUQ0hFRCxcbiAgICAgIFRyYW5zbGF0aW9uU2VydmljZS5sYW5ndWFnZVxuICAgICk7XG4gICAgdGhpcy5vbkNoYW5nZShyZXN1bHQpO1xuICB9XG5cbiAgcHVibGljIGhhbmRsZUVycm9yKGVycm9yOiBhbnkpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnJvci5tZXNzYWdlIHx8IGVycm9yKTtcbiAgfVxufVxuIl19