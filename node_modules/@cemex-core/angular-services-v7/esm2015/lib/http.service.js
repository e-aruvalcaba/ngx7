/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { Headers, Http, RequestOptions } from '@angular/http';
import { Observable } from 'rxjs';
import { ProjectSettings } from './project.settings';
export class HttpCemex {
    /**
     * @param {?} http
     * @param {?} projectSettings
     */
    constructor(http, projectSettings) {
        this.http = http;
        this.projectSettings = projectSettings;
        this._validSettings = false;
        this._validSettings = this.validateProjectSettings();
    }
    /**
     * @param {?} apiEndpoint
     * @return {?}
     */
    generateEndpoint(apiEndpoint) {
        return this.projectSettings.generateEndpoint(apiEndpoint);
    }
    /**
     * @return {?}
     */
    get clientId() {
        return this.projectSettings.clientId;
    }
    /**
     * @return {?}
     */
    get appCode() {
        return this.projectSettings.appCode;
    }
    /**
     * @param {?} url
     * @param {?=} options
     * @return {?}
     */
    request(url, options) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options);
        return this.http.request(url, loptions);
    }
    /**
     * @param {?} url
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    get(url, options, overrideHeader) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.get(url, loptions);
    }
    /**
     * @param {?} url
     * @param {?} body
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    post(url, body, options, overrideHeader) {
        if (!this._validSettings) {
            /** @type {?} */
            const message = 'Set missing environment variables of API_HOST, API_ORG, API_ENV, APP_CODE, CLIENT_ID';
            return Observable.throw(new Error(message));
        }
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.post(url, body, loptions);
    }
    /**
     * @param {?} url
     * @param {?} body
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    put(url, body, options, overrideHeader) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.put(url, body, loptions);
    }
    /**
     * @param {?} url
     * @param {?} body
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    patch(url, body, options, overrideHeader) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.patch(url, body, loptions);
    }
    /**
     * @param {?} url
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    delete(url, options, overrideHeader) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.delete(url, loptions);
    }
    /**
     * @param {?} url
     * @param {?=} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    head(url, options, overrideHeader) {
        /** @type {?} */
        const loptions = this.createAuthorizationHeader(options, overrideHeader);
        return this.http.head(url, loptions);
    }
    /**
     * @return {?}
     */
    isRunningOnBrowser() {
        return ((/** @type {?} */ (global))) !== null && ((/** @type {?} */ (global))) !== undefined;
    }
    /**
     * @param {?} str
     * @return {?}
     */
    encrypt(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    }
    /**
     * @param {?} str
     * @return {?}
     */
    decrypt(str) {
        return str ? decodeURIComponent(escape(window.atob(str))) : str;
    }
    /**
     * @param {?} newKeys
     * @return {?}
     */
    setProjectSettingsNewKeys(newKeys) {
        this.projectSettings.setAppKeys(newKeys);
    }
    /**
     * @protected
     * @param {?} options
     * @param {?=} overrideHeader
     * @return {?}
     */
    createAuthorizationHeader(options, overrideHeader) {
        /** @type {?} */
        const containsHeader = options && options.headers && options.headers.keys().length > 0;
        /** @type {?} */
        const result = options
            ? Object.assign({}, options)
            : new RequestOptions();
        /** @type {?} */
        const headers = new Headers();
        /** @type {?} */
        const language = this.isRunningOnBrowser()
            ? ((/** @type {?} */ (window))).localStorage.getItem('language') || 'en'
            : 'en';
        headers.append('Accept', 'application/json');
        headers.append('X-IBM-Client-Id', this.projectSettings.clientId);
        headers.append('App-Code', this.projectSettings.appCode);
        headers.append('Accept-Language', language);
        /** @type {?} */
        const accessToken = sessionStorage.getItem('access_token');
        /** @type {?} */
        const isContainsToken = accessToken && accessToken !== undefined;
        if (isContainsToken) {
            headers.append('Authorization', 'Bearer ' + accessToken);
        }
        /** @type {?} */
        const jwtApp = sessionStorage.getItem('jwt');
        if (this.isRunningOnBrowser() && jwtApp && jwtApp !== undefined) {
            headers.append('jwt', jwtApp);
        }
        // overwrite existing headers or add new headers
        /** @type {?} */
        const headerKeys = containsHeader ? options.headers.keys() : [];
        for (const keyHeader of headerKeys) {
            headers.set(keyHeader, options.headers.get(keyHeader));
        }
        result.headers = headers;
        if (overrideHeader && containsHeader) {
            result.headers = options.headers;
        }
        return result;
    }
    /**
     * @private
     * @return {?}
     */
    validateProjectSettings() {
        /** @type {?} */
        const settings = this.projectSettings;
        return (settings.apiBasePath !== undefined &&
            settings.apiEnv !== undefined &&
            settings.apiOrg !== undefined &&
            settings.appCode !== undefined &&
            settings.clientId !== undefined);
    }
}
HttpCemex.decorators = [
    { type: Injectable }
];
/** @nocollapse */
HttpCemex.ctorParameters = () => [
    { type: Http },
    { type: ProjectSettings }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    HttpCemex.prototype._validSettings;
    /**
     * @type {?}
     * @protected
     */
    HttpCemex.prototype.http;
    /**
     * @type {?}
     * @private
     */
    HttpCemex.prototype.projectSettings;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGNlbWV4LWNvcmUvYW5ndWxhci1zZXJ2aWNlcy12Ny8iLCJzb3VyY2VzIjpbImxpYi9odHRwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNMLE9BQU8sRUFDUCxJQUFJLEVBRUosY0FBYyxFQUVmLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFbEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBS3JELE1BQU0sT0FBTyxTQUFTOzs7OztJQUdwQixZQUFzQixJQUFVLEVBQVUsZUFBZ0M7UUFBcEQsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUZsRSxtQkFBYyxHQUFHLEtBQUssQ0FBQztRQUc3QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0lBQ3ZELENBQUM7Ozs7O0lBRU0sZ0JBQWdCLENBQUMsV0FBbUI7UUFDekMsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzVELENBQUM7Ozs7SUFFRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7Ozs7SUFFRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDO0lBQ3RDLENBQUM7Ozs7OztJQUVNLE9BQU8sQ0FBQyxHQUFxQixFQUFFLE9BQTRCOztjQUMxRCxRQUFRLEdBQXVCLElBQUksQ0FBQyx5QkFBeUIsQ0FDakUsT0FBTyxDQUNSO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFH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TyxDQUFDLEtBQUssQ0FBQztRQUM1QyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLE1BQU0sSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO1lBQy9ELE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQy9COzs7Y0FHSyxVQUFVLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQy9ELEtBQUssTUFBTSxTQUFTLElBQUksVUFBVSxFQUFFO1lBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7U0FDeEQ7UUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUV6QixJQUFJLGNBQWMsSUFBSSxjQUFjLEVBQUU7WUFDcEMsTUFBTSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1NBQ2xDO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQzs7Ozs7SUFFTyx1QkFBdUI7O2NBQ3ZCLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZTtRQUNyQyxPQUFPLENBQ0wsUUFBUSxDQUFDLFdBQVcsS0FBSyxTQUFTO1lBQ2xDLFFBQVEsQ0FBQyxNQUFNLEtBQUssU0FBUztZQUM3QixRQUFRLENBQUMsTUFBTSxLQUFLLFNBQVM7WUFDN0IsUUFBUSxDQUFDLE9BQU8sS0FBSyxTQUFTO1lBQzlCLFFBQVEsQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUNoQyxDQUFDO0lBQ0osQ0FBQzs7O1lBakxGLFVBQVU7Ozs7WUFaVCxJQUFJO1lBUUcsZUFBZTs7Ozs7OztJQU10QixtQ0FBK0I7Ozs7O0lBRW5CLHlCQUFvQjs7Ozs7SUFBRSxvQ0FBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIZWFkZXJzLFxuICBIdHRwLFxuICBSZXF1ZXN0LFxuICBSZXF1ZXN0T3B0aW9ucyxcbiAgUmVxdWVzdE9wdGlvbnNBcmdzXG59IGZyb20gJ0Bhbmd1bGFyL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IFByb2plY3RTZXR0aW5ncyB9IGZyb20gJy4vcHJvamVjdC5zZXR0aW5ncyc7XG5cbmRlY2xhcmUgdmFyIGdsb2JhbDogYW55O1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgSHR0cENlbWV4IHtcbiAgcHJpdmF0ZSBfdmFsaWRTZXR0aW5ncyA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBodHRwOiBIdHRwLCBwcml2YXRlIHByb2plY3RTZXR0aW5nczogUHJvamVjdFNldHRpbmdzKSB7XG4gICAgdGhpcy5fdmFsaWRTZXR0aW5ncyA9IHRoaXMudmFsaWRhdGVQcm9qZWN0U2V0dGluZ3MoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZW5lcmF0ZUVuZHBvaW50KGFwaUVuZHBvaW50OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb2plY3RTZXR0aW5ncy5nZW5lcmF0ZUVuZHBvaW50KGFwaUVuZHBvaW50KTtcbiAgfVxuXG4gIGdldCBjbGllbnRJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb2plY3RTZXR0aW5ncy5jbGllbnRJZDtcbiAgfVxuXG4gIGdldCBhcHBDb2RlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucHJvamVjdFNldHRpbmdzLmFwcENvZGU7XG4gIH1cblxuICBwdWJsaWMgcmVxdWVzdCh1cmw6IHN0cmluZyB8IFJlcXVlc3QsIG9wdGlvbnM/OiBSZXF1ZXN0T3B0aW9uc0FyZ3MpIHtcbiAgICBjb25zdCBsb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzID0gdGhpcy5jcmVhdGVBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgb3B0aW9uc1xuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5yZXF1ZXN0KHVybCwgbG9wdGlvbnMpO1xuICB9XG5cbiAgcHVibGljIGdldChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnNBcmdzLFxuICAgIG92ZXJyaWRlSGVhZGVyPzogYm9vbGVhblxuICApIHtcbiAgICBjb25zdCBsb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzID0gdGhpcy5jcmVhdGVBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIG92ZXJyaWRlSGVhZGVyXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIGxvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBwb3N0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGJvZHk6IGFueSxcbiAgICBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnNBcmdzLFxuICAgIG92ZXJyaWRlSGVhZGVyPzogYm9vbGVhblxuICApOiBhbnkge1xuICAgIGlmICghdGhpcy5fdmFsaWRTZXR0aW5ncykge1xuICAgICAgY29uc3QgbWVzc2FnZSA9XG4gICAgICAgICdTZXQgbWlzc2luZyBlbnZpcm9ubWVudCB2YXJpYWJsZXMgb2YgQVBJX0hPU1QsIEFQSV9PUkcsIEFQSV9FTlYsIEFQUF9DT0RFLCBDTElFTlRfSUQnO1xuICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3cobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICB9XG5cbiAgICBjb25zdCBsb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzID0gdGhpcy5jcmVhdGVBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIG92ZXJyaWRlSGVhZGVyXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QodXJsLCBib2R5LCBsb3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgcHV0KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGJvZHk6IGFueSxcbiAgICBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnNBcmdzLFxuICAgIG92ZXJyaWRlSGVhZGVyPzogYm9vbGVhblxuICApIHtcbiAgICBjb25zdCBsb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzID0gdGhpcy5jcmVhdGVBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIG92ZXJyaWRlSGVhZGVyXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLnB1dCh1cmwsIGJvZHksIGxvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBwYXRjaChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBib2R5OiBhbnksXG4gICAgb3B0aW9ucz86IFJlcXVlc3RPcHRpb25zQXJncyxcbiAgICBvdmVycmlkZUhlYWRlcj86IGJvb2xlYW5cbiAgKSB7XG4gICAgY29uc3QgbG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zQXJncyA9IHRoaXMuY3JlYXRlQXV0aG9yaXphdGlvbkhlYWRlcihcbiAgICAgIG9wdGlvbnMsXG4gICAgICBvdmVycmlkZUhlYWRlclxuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wYXRjaCh1cmwsIGJvZHksIGxvcHRpb25zKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWxldGUoXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IFJlcXVlc3RPcHRpb25zQXJncyxcbiAgICBvdmVycmlkZUhlYWRlcj86IGJvb2xlYW5cbiAgKSB7XG4gICAgY29uc3QgbG9wdGlvbnM6IFJlcXVlc3RPcHRpb25zQXJncyA9IHRoaXMuY3JlYXRlQXV0aG9yaXphdGlvbkhlYWRlcihcbiAgICAgIG9wdGlvbnMsXG4gICAgICBvdmVycmlkZUhlYWRlclxuICAgICk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUodXJsLCBsb3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgaGVhZChcbiAgICB1cmw6IHN0cmluZyxcbiAgICBvcHRpb25zPzogUmVxdWVzdE9wdGlvbnNBcmdzLFxuICAgIG92ZXJyaWRlSGVhZGVyPzogYm9vbGVhblxuICApIHtcbiAgICBjb25zdCBsb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzID0gdGhpcy5jcmVhdGVBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgb3B0aW9ucyxcbiAgICAgIG92ZXJyaWRlSGVhZGVyXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5odHRwLmhlYWQodXJsLCBsb3B0aW9ucyk7XG4gIH1cblxuICBwdWJsaWMgaXNSdW5uaW5nT25Ccm93c2VyKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoZ2xvYmFsIGFzIGFueSkgIT09IG51bGwgJiYgKGdsb2JhbCBhcyBhbnkpICE9PSB1bmRlZmluZWQ7XG4gIH1cblxuICBwdWJsaWMgZW5jcnlwdChzdHIpIHtcbiAgICByZXR1cm4gd2luZG93LmJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KHN0cikpKTtcbiAgfVxuXG4gIHB1YmxpYyBkZWNyeXB0KHN0cikge1xuICAgIHJldHVybiBzdHIgPyBkZWNvZGVVUklDb21wb25lbnQoZXNjYXBlKHdpbmRvdy5hdG9iKHN0cikpKSA6IHN0cjtcbiAgfVxuXG4gIHB1YmxpYyBzZXRQcm9qZWN0U2V0dGluZ3NOZXdLZXlzKG5ld0tleXMpOiB2b2lkIHtcbiAgICB0aGlzLnByb2plY3RTZXR0aW5ncy5zZXRBcHBLZXlzKG5ld0tleXMpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNyZWF0ZUF1dGhvcml6YXRpb25IZWFkZXIoXG4gICAgb3B0aW9uczogUmVxdWVzdE9wdGlvbnNBcmdzLFxuICAgIG92ZXJyaWRlSGVhZGVyPzogYm9vbGVhblxuICApOiBSZXF1ZXN0T3B0aW9uc0FyZ3Mge1xuICAgIGNvbnN0IGNvbnRhaW5zSGVhZGVyID1cbiAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5oZWFkZXJzICYmIG9wdGlvbnMuaGVhZGVycy5rZXlzKCkubGVuZ3RoID4gMDtcbiAgICBjb25zdCByZXN1bHQ6IFJlcXVlc3RPcHRpb25zQXJncyA9IG9wdGlvbnNcbiAgICAgID8gT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucylcbiAgICAgIDogbmV3IFJlcXVlc3RPcHRpb25zKCk7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7XG4gICAgY29uc3QgbGFuZ3VhZ2UgPSB0aGlzLmlzUnVubmluZ09uQnJvd3NlcigpXG4gICAgICA/ICh3aW5kb3cgYXMgYW55KS5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2UnKSB8fCAnZW4nXG4gICAgICA6ICdlbic7XG5cbiAgICBoZWFkZXJzLmFwcGVuZCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICBoZWFkZXJzLmFwcGVuZCgnWC1JQk0tQ2xpZW50LUlkJywgdGhpcy5wcm9qZWN0U2V0dGluZ3MuY2xpZW50SWQpO1xuICAgIGhlYWRlcnMuYXBwZW5kKCdBcHAtQ29kZScsIHRoaXMucHJvamVjdFNldHRpbmdzLmFwcENvZGUpO1xuICAgIGhlYWRlcnMuYXBwZW5kKCdBY2NlcHQtTGFuZ3VhZ2UnLCBsYW5ndWFnZSk7XG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCdhY2Nlc3NfdG9rZW4nKTtcbiAgICBjb25zdCBpc0NvbnRhaW5zVG9rZW4gPSBhY2Nlc3NUb2tlbiAmJiBhY2Nlc3NUb2tlbiAhPT0gdW5kZWZpbmVkO1xuICAgIGlmIChpc0NvbnRhaW5zVG9rZW4pIHtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdBdXRob3JpemF0aW9uJywgJ0JlYXJlciAnICsgYWNjZXNzVG9rZW4pO1xuICAgIH1cblxuICAgIGNvbnN0IGp3dEFwcCA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oJ2p3dCcpO1xuICAgIGlmICh0aGlzLmlzUnVubmluZ09uQnJvd3NlcigpICYmIGp3dEFwcCAmJiBqd3RBcHAgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaGVhZGVycy5hcHBlbmQoJ2p3dCcsIGp3dEFwcCk7XG4gICAgfVxuXG4gICAgLy8gb3ZlcndyaXRlIGV4aXN0aW5nIGhlYWRlcnMgb3IgYWRkIG5ldyBoZWFkZXJzXG4gICAgY29uc3QgaGVhZGVyS2V5cyA9IGNvbnRhaW5zSGVhZGVyID8gb3B0aW9ucy5oZWFkZXJzLmtleXMoKSA6IFtdO1xuICAgIGZvciAoY29uc3Qga2V5SGVhZGVyIG9mIGhlYWRlcktleXMpIHtcbiAgICAgIGhlYWRlcnMuc2V0KGtleUhlYWRlciwgb3B0aW9ucy5oZWFkZXJzLmdldChrZXlIZWFkZXIpKTtcbiAgICB9XG5cbiAgICByZXN1bHQuaGVhZGVycyA9IGhlYWRlcnM7XG5cbiAgICBpZiAob3ZlcnJpZGVIZWFkZXIgJiYgY29udGFpbnNIZWFkZXIpIHtcbiAgICAgIHJlc3VsdC5oZWFkZXJzID0gb3B0aW9ucy5oZWFkZXJzO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlUHJvamVjdFNldHRpbmdzKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNldHRpbmdzID0gdGhpcy5wcm9qZWN0U2V0dGluZ3M7XG4gICAgcmV0dXJuIChcbiAgICAgIHNldHRpbmdzLmFwaUJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiZcbiAgICAgIHNldHRpbmdzLmFwaUVudiAhPT0gdW5kZWZpbmVkICYmXG4gICAgICBzZXR0aW5ncy5hcGlPcmcgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgc2V0dGluZ3MuYXBwQ29kZSAhPT0gdW5kZWZpbmVkICYmXG4gICAgICBzZXR0aW5ncy5jbGllbnRJZCAhPT0gdW5kZWZpbmVkXG4gICAgKTtcbiAgfVxufVxuIl19