/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { PushNotificationsConstants } from './push-notifications.constants';
export class PushNotificationService {
    /**
     * @param {?} constants
     */
    constructor(constants) {
        this.constants = constants;
        this._devUUID = '';
        this._devId = '';
        this._platform = '';
        this._token = '';
        // this.initialize();
    }
    /**
     * @param {?} methodCallBack
     * @return {?}
     */
    initialize(methodCallBack) {
        this._methodCallBack = methodCallBack;
        this._vapidPublicKey = this.constants.getVapidPublicKey();
        if (this.validateSw()) {
            // tslint:disable-next-line:only-arrow-functions
            /** @type {?} */
            const swReg = this.registerSw().catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                console.log('Push Service Worker registration has failed: ' + error);
            }));
            // tslint:disable-next-line:only-arrow-functions
            this.subscriptionSw(swReg).catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                console.log('Push Service Worker subscription has failed: ' + error);
            }));
        }
    }
    /**
     * @return {?}
     */
    validateSw() {
        /** @type {?} */
        let isValid = false;
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            isValid = true;
            console.log('Service Workers is supported');
        }
        return isValid;
    }
    /**
     * @private
     * @return {?}
     */
    registerSw() {
        // tslint:disable-next-line:only-arrow-functions
        return navigator.serviceWorker
            .register(this.constants.getUrlSW())
            .then((/**
         * @param {?} swReg
         * @return {?}
         */
        function (swReg) {
            if (swReg.installing) {
                console.log('Service worker installing');
            }
            else if (swReg.waiting) {
                console.log('Service worker installed');
            }
            else if (swReg.active) {
                console.log('Service worker active');
            }
            if (!swReg.showNotification) {
                console.log('Notifications aren\'t supported on service workers.');
            }
            return swReg;
        }));
    }
    /**
     * @private
     * @param {?} registration
     * @return {?}
     */
    subscriptionSw(registration) {
        /** @type {?} */
        const mSetSubscription = this.setSubscription;
        /** @type {?} */
        const global = this;
        // tslint:disable-next-line:only-arrow-functions
        return registration.then((/**
         * @param {?} swReg
         * @return {?}
         */
        function (swReg) {
            swReg.pushManager
                .getSubscription()
                // tslint:disable-next-line:only-arrow-functions
                .then((/**
             * @param {?} subscriptionInit
             * @return {?}
             */
            function (subscriptionInit) {
                if (subscriptionInit) {
                    return mSetSubscription(subscriptionInit, global);
                }
                else {
                    /** @type {?} */
                    const options = {
                        // tslint:disable-next-line:max-line-length
                        applicationServerKey: !global._vapidPublicKey
                            ? null
                            : global.urlB64ToUint8Array(global._vapidPublicKey),
                        userVisibleOnly: true
                    };
                    return (swReg.pushManager
                        .subscribe(options)
                        // tslint:disable-next-line:only-arrow-functions
                        .then((/**
                     * @param {?} subscription
                     * @return {?}
                     */
                    function (subscription) {
                        console.log(subscription);
                        return mSetSubscription(subscription, global);
                        // tslint:disable-next-line:only-arrow-functions
                    }))
                        .catch((/**
                     * @param {?} error
                     * @return {?}
                     */
                    function (error) {
                        console.log('Unable to subscribe to push.', error);
                    })));
                }
            }));
        }));
    }
    /**
     * @private
     * @param {?} subscription
     * @param {?} global
     * @return {?}
     */
    setSubscription(subscription, global) {
        global.generateTokenForRegisterDevice(subscription);
        global.registerBroadcastListener();
    }
    /**
     * @private
     * @return {?}
     */
    registerBroadcastListener() {
        /** @type {?} */
        const callBack = this._methodCallBack;
        /** @type {?} */
        const sPush = this.constants.getSourcePush();
        navigator.serviceWorker.addEventListener('message', (/**
         * @param {?} event
         * @return {?}
         */
        function handler(event) {
            /** @type {?} */
            const data = event.data;
            if (data && data.source === sPush) {
                console.log(event.data);
                if (callBack) {
                    callBack(data.payload);
                }
            }
        }));
    }
    // tslint:disable-next-line:member-ordering
    /**
     * @param {?} subscription
     * @return {?}
     */
    generateTokenForRegisterDevice(subscription) {
        localStorage.setItem('token', JSON.stringify(subscription));
        if (!localStorage.getItem('deviceUUID')) {
            this.generateUUID('');
        }
        else {
            this._devUUID = localStorage.getItem('deviceUUID');
            if (!localStorage.getItem('deviceId')) {
                this._devId = localStorage.getItem('deviceId');
            }
        }
        this._platform = '';
        this._devUUID = localStorage.getItem('deviceUUID');
        this._devId = localStorage.getItem('deviceId');
        /** @type {?} */
        const rawKey = subscription.getKey ? subscription.getKey('p256dh') : '';
        /** @type {?} */
        const key = rawKey
            ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawKey)))
            : '';
        /** @type {?} */
        const rawAuthSecret = subscription.getKey
            ? subscription.getKey('auth')
            : '';
        /** @type {?} */
        const authSecret = rawAuthSecret
            ? btoa(String.fromCharCode.apply(null, new Uint8Array(rawAuthSecret)))
            : '';
        /** @type {?} */
        const tokenValue = {
            endpoint: subscription.endpoint,
            userAuth: authSecret,
            userPublicKey: key
        };
        this._token = JSON.stringify(tokenValue);
        if (navigator.userAgent.indexOf('Firefox') !== -1) {
            this._platform = 'F'; // Firefox Browser
        }
        else if (navigator.userAgent.indexOf('Chrome') !== -1) {
            this._platform = 'C'; // Chrome Browser
        }
        /** @type {?} */
        let device = null;
        if (this.validateInput(this._devId)) {
            device = {
                deviceId: this._devId,
                platform: this._platform,
                token: this._token,
                uuid: this._devUUID
            };
        }
        else {
            device = {
                platform: this._platform,
                token: this._token,
                uuid: this._devUUID
            };
        }
        this.registerDevice(device);
    }
    // tslint:disable-next-line:member-ordering
    /**
     * @param {?} device
     * @return {?}
     */
    registerDevice(device) {
        console.log('Device details:', device);
        /** @type {?} */
        const xhr = this.setRequest(this.constants.getDevicesPath(), 'POST', true);
        /*this.http.post(this.constants.getDevicesPath(), device)
            .then((response) => {
                console.log('Response register,', response);
                localStorage.setItem('deviceId', response);
            });*/
        // tslint:disable-next-line:only-arrow-functions
        xhr.onreadystatechange = (/**
         * @return {?}
         */
        function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log('Response register,', xhr);
                localStorage.setItem('deviceId', xhr.responseText);
            }
        });
        xhr.send(JSON.stringify(device));
    }
    // tslint:disable-next-line:member-ordering
    /**
     * @return {?}
     */
    unRegisterDevice() {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this._devId = localStorage.getItem('deviceId');
            /** @type {?} */
            const global = this;
            // tslint:disable-next-line:only-arrow-functions
            navigator.serviceWorker.ready
                .then((/**
             * @param {?} registration
             * @return {?}
             */
            function (registration) {
                registration
                    .unregister()
                    // tslint:disable-next-line:only-arrow-functions
                    .then((/**
                 * @param {?} checkUnregister
                 * @return {?}
                 */
                function (checkUnregister) {
                    if (!checkUnregister) {
                        console.log('unregister failed');
                        resolve();
                    }
                    global
                        .unsubscribeDevice(global._devId, global)
                        // tslint:disable-next-line:only-arrow-functions
                        .then((/**
                     * @return {?}
                     */
                    function () {
                        resolve();
                    }));
                }));
            }))
                // tslint:disable-next-line:only-arrow-functions
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                console.log('Registration failed with ' + error);
                resolve();
            }));
        }));
        return promise;
    }
    // tslint:disable-next-line:member-ordering
    /**
     * @param {?} deviceID
     * @param {?} global
     * @return {?}
     */
    unsubscribeDevice(deviceID, global) {
        /** @type {?} */
        const promise = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            /** @type {?} */
            const deviceId = localStorage.getItem('deviceId');
            /** @type {?} */
            const device = {
                devices: {
                    deviceId: global._devId,
                    platform: global._platform,
                    token: global._token,
                    uuid: global._devUUID
                }
            };
            if (deviceID) {
                /** @type {?} */
                const xhr = global.setRequest(global.constants.getDevicesPath() + '/' + deviceID, 'DELETE', true);
                // tslint:disable-next-line:only-arrow-functions
                xhr.onreadystatechange = (/**
                 * @return {?}
                 */
                function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        console.log('The response is ,', xhr);
                        console.log('Successfully unregistered the device');
                        localStorage.setItem('deviceUUID', '');
                        localStorage.setItem('deviceId', '');
                        localStorage.setItem('token', '');
                        resolve();
                    }
                });
                xhr.send(JSON.stringify(device));
            }
            else {
                resolve();
            }
        }));
        return promise;
    }
    /**
     * @private
     * @param {?} url
     * @param {?} method
     * @param {?} asyncP
     * @return {?}
     */
    setRequest(url, method, asyncP) {
        /** @type {?} */
        let xhr = new XMLHttpRequest();
        xhr.open(method, url, asyncP);
        xhr = this.setHeaders(xhr, method);
        return xhr;
    }
    /**
     * @private
     * @param {?} xhr
     * @param {?} method
     * @return {?}
     */
    setHeaders(xhr, method) {
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.setRequestHeader('x-ibm-client-id', this.constants.getClientId());
        xhr.setRequestHeader('App-Code', this.constants.getAppCode());
        xhr.setRequestHeader('Accept-Language', this.constants.getAppLanguage());
        xhr.setRequestHeader('Authorization', this.constants.getAuthToken());
        xhr.setRequestHeader('jwt', this.constants.getJwt());
        xhr.timeout = 3000;
        if (method === 'POST' || method === 'PUT') {
            xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
        }
        return xhr;
    }
    /**
     * @private
     * @param {?} token
     * @return {?}
     */
    generateUUID(token) {
        /** @type {?} */
        let dateTime = new Date().getTime();
        if (window.performance && typeof window.performance.now === 'function') {
            dateTime += performance.now(); // use high-precision timer if available
        }
        /** @type {?} */
        const hostname = window.location.hostname;
        /** @type {?} */
        const arrayData = [];
        arrayData.push(this.hashCode(dateTime));
        arrayData.push(this.hashCode(token));
        arrayData.push(this.hashCode(hostname));
        arrayData.push(this.hashCode(this._platform));
        /** @type {?} */
        const finalString = arrayData
            .join('')
            .replace(/[-.]/g, '')
            .replace(/[,.]/g, '');
        /** @type {?} */
        let uuid = '';
        for (let i = 0; i < 32; i++) {
            uuid += finalString.charAt(Math.floor(Math.random() * finalString.length));
        }
        localStorage.setItem('deviceUUID', uuid);
        this._devUUID = uuid;
        return this._devUUID;
    }
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    hashCode(str) {
        /** @type {?} */
        let hash = 0;
        /** @type {?} */
        let i;
        /** @type {?} */
        let chr;
        /** @type {?} */
        let len;
        if (str.length === 0) {
            return hash;
        }
        for (i = 0, len = str.length; i < len; i++) {
            chr = str.charCodeAt(i);
            // tslint:disable-next-line:no-bitwise
            hash = (hash << 5) - hash + chr;
            // tslint:disable-next-line:no-bitwise
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    }
    /**
     * @private
     * @param {?} stringValue
     * @return {?}
     */
    validateInput(stringValue) {
        // tslint:disable-next-line:max-line-length
        return stringValue === undefined ||
            stringValue == null ||
            stringValue.length <= 0 ||
            stringValue === ''
            ? false
            : true;
    }
    /**
     * @private
     * @param {?} base64String
     * @return {?}
     */
    urlB64ToUint8Array(base64String) {
        /** @type {?} */
        const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
        /** @type {?} */
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
        /** @type {?} */
        const rawData = window.atob(base64);
        /** @type {?} */
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }
}
PushNotificationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PushNotificationService.ctorParameters = () => [
    { type: PushNotificationsConstants }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._devUUID;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._devId;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._platform;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._token;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._methodCallBack;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype._vapidPublicKey;
    /**
     * @type {?}
     * @private
     */
    PushNotificationService.prototype.constants;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVzaC1ub3RpZmljYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY2VtZXgtY29yZS9hbmd1bGFyLXNlcnZpY2VzLXY3LyIsInNvdXJjZXMiOlsibGliL3B1c2gtbm90aWZpY2F0aW9ucy9wdXNoLW5vdGlmaWNhdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUc1RSxNQUFNLE9BQU8sdUJBQXVCOzs7O0lBUWxDLFlBQW9CLFNBQXFDO1FBQXJDLGNBQVMsR0FBVCxTQUFTLENBQTRCO1FBUGpELGFBQVEsR0FBRyxFQUFFLENBQUM7UUFDZCxXQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1osY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFLbEIscUJBQXFCO0lBQ3ZCLENBQUM7Ozs7O0lBRU0sVUFBVSxDQUFDLGNBQW1CO1FBQ25DLElBQUksQ0FBQyxlQUFlLEdBQUcsY0FBYyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQzFELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFOzs7a0JBRWYsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxLQUFLOzs7O1lBQUMsVUFBUyxLQUFLO2dCQUNsRCxPQUFPLENBQUMsR0FBRyxDQUFDLCtDQUErQyxHQUFHLEtBQUssQ0FBQyxDQUFDO1lBQ3ZFLENBQUMsRUFBQztZQUNGLGdEQUFnRDtZQUNoRCxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUs7Ozs7WUFBQyxVQUFTLEtBQUs7Z0JBQzdDLE9BQU8sQ0FBQyxHQUFHLENBQUMsK0NBQStDLEdBQUcsS0FBSyxDQUFD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QUFDLFlBQVksR0FBRyxPQUFPLENBQUM7YUFDcEMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUM7YUFDbkIsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUM7O2NBRWYsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDOztjQUM3QixXQUFXLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztRQUVsRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtZQUN2QyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN4QztRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7OztZQWhXRixVQUFVOzs7O1lBRkYsMEJBQTBCOzs7Ozs7O0lBSWpDLDJDQUFzQjs7Ozs7SUFDdEIseUNBQW9COzs7OztJQUNwQiw0Q0FBdUI7Ozs7O0lBQ3ZCLHlDQUFvQjs7Ozs7SUFDcEIsa0RBQTZCOzs7OztJQUM3QixrREFBZ0M7Ozs7O0lBRXBCLDRDQUE2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFB1c2hOb3RpZmljYXRpb25zQ29uc3RhbnRzIH0gZnJvbSAnLi9wdXNoLW5vdGlmaWNhdGlvbnMuY29uc3RhbnRzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFB1c2hOb3RpZmljYXRpb25TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBfZGV2VVVJRCA9ICcnO1xuICBwcml2YXRlIF9kZXZJZCA9ICcnO1xuICBwcml2YXRlIF9wbGF0Zm9ybSA9ICcnO1xuICBwcml2YXRlIF90b2tlbiA9ICcnO1xuICBwcml2YXRlIF9tZXRob2RDYWxsQmFjazogYW55O1xuICBwcml2YXRlIF92YXBpZFB1YmxpY0tleTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29uc3RhbnRzOiBQdXNoTm90aWZpY2F0aW9uc0NvbnN0YW50cykge1xuICAgIC8vIHRoaXMuaW5pdGlhbGl6ZSgpO1xuICB9XG5cbiAgcHVibGljIGluaXRpYWxpemUobWV0aG9kQ2FsbEJhY2s6IGFueSk6IHZvaWQge1xuICAgIHRoaXMuX21ldGhvZENhbGxCYWNrID0gbWV0aG9kQ2FsbEJhY2s7XG4gICAgdGhpcy5fdmFwaWRQdWJsaWNLZXkgPSB0aGlzLmNvbnN0YW50cy5nZXRWYXBpZFB1YmxpY0tleSgpO1xuICAgIGlmICh0aGlzLnZhbGlkYXRlU3coKSkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgICBjb25zdCBzd1JlZyA9IHRoaXMucmVnaXN0ZXJTdygpLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQdXNoIFNlcnZpY2UgV29ya2VyIHJlZ2lzdHJhdGlvbiBoYXMgZmFpbGVkOiAnICsgZXJyb3IpO1xuICAgICAgfSk7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uU3coc3dSZWcpLmNhdGNoKGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQdXNoIFNlcnZpY2UgV29ya2VyIHN1YnNjcmlwdGlvbiBoYXMgZmFpbGVkOiAnICsgZXJyb3IpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHZhbGlkYXRlU3coKTogYm9vbGVhbiB7XG4gICAgbGV0IGlzVmFsaWQgPSBmYWxzZTtcbiAgICBpZiAoJ3NlcnZpY2VXb3JrZXInIGluIG5hdmlnYXRvciAmJiAnUHVzaE1hbmFnZXInIGluIHdpbmRvdykge1xuICAgICAgaXNWYWxpZCA9IHRydWU7XG4gICAgICBjb25zb2xlLmxvZygnU2VydmljZSBXb3JrZXJzIGlzIHN1cHBvcnRlZCcpO1xuICAgIH1cbiAgICByZXR1cm4gaXNWYWxpZDtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJTdygpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICByZXR1cm4gbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXJcbiAgICAgIC5yZWdpc3Rlcih0aGlzLmNvbnN0YW50cy5nZXRVcmxTVygpKVxuICAgICAgLnRoZW4oZnVuY3Rpb24oc3dSZWcpIHtcbiAgICAgICAgaWYgKHN3UmVnLmluc3RhbGxpbmcpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU2VydmljZSB3b3JrZXIgaW5zdGFsbGluZycpO1xuICAgICAgICB9IGVsc2UgaWYgKHN3UmVnLndhaXRpbmcpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZygnU2VydmljZSB3b3JrZXIgaW5zdGFsbGVkJyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3dSZWcuYWN0aXZlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1NlcnZpY2Ugd29ya2VyIGFjdGl2ZScpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc3dSZWcuc2hvd05vdGlmaWNhdGlvbikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdOb3RpZmljYXRpb25zIGFyZW5cXCd0IHN1cHBvcnRlZCBvbiBzZXJ2aWNlIHdvcmtlcnMuJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHN3UmVnO1xuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmlwdGlvblN3KHJlZ2lzdHJhdGlvbikge1xuICAgIGNvbnN0IG1TZXRTdWJzY3JpcHRpb24gPSB0aGlzLnNldFN1YnNjcmlwdGlvbjtcbiAgICBjb25zdCBnbG9iYWwgPSB0aGlzO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgIHJldHVybiByZWdpc3RyYXRpb24udGhlbihmdW5jdGlvbihzd1JlZykge1xuICAgICAgc3dSZWcucHVzaE1hbmFnZXJcbiAgICAgICAgLmdldFN1YnNjcmlwdGlvbigpXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgICAudGhlbihmdW5jdGlvbihzdWJzY3JpcHRpb25Jbml0KSB7XG4gICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbkluaXQpIHtcbiAgICAgICAgICAgIHJldHVybiBtU2V0U3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbkluaXQsIGdsb2JhbCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICAgICAgYXBwbGljYXRpb25TZXJ2ZXJLZXk6ICFnbG9iYWwuX3ZhcGlkUHVibGljS2V5XG4gICAgICAgICAgICAgICAgPyBudWxsXG4gICAgICAgICAgICAgICAgOiBnbG9iYWwudXJsQjY0VG9VaW50OEFycmF5KGdsb2JhbC5fdmFwaWRQdWJsaWNLZXkpLFxuICAgICAgICAgICAgICB1c2VyVmlzaWJsZU9ubHk6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICBzd1JlZy5wdXNoTWFuYWdlclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUob3B0aW9ucylcbiAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbihzdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHN1YnNjcmlwdGlvbik7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gbVNldFN1YnNjcmlwdGlvbihzdWJzY3JpcHRpb24sIGdsb2JhbCk7XG4gICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6b25seS1hcnJvdy1mdW5jdGlvbnNcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VuYWJsZSB0byBzdWJzY3JpYmUgdG8gcHVzaC4nLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbiwgZ2xvYmFsKSB7XG4gICAgZ2xvYmFsLmdlbmVyYXRlVG9rZW5Gb3JSZWdpc3RlckRldmljZShzdWJzY3JpcHRpb24pO1xuICAgIGdsb2JhbC5yZWdpc3RlckJyb2FkY2FzdExpc3RlbmVyKCk7XG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyQnJvYWRjYXN0TGlzdGVuZXIoKSB7XG4gICAgY29uc3QgY2FsbEJhY2sgPSB0aGlzLl9tZXRob2RDYWxsQmFjaztcbiAgICBjb25zdCBzUHVzaCA9IHRoaXMuY29uc3RhbnRzLmdldFNvdXJjZVB1c2goKTtcbiAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gaGFuZGxlcihcbiAgICAgIGV2ZW50XG4gICAgKSB7XG4gICAgICBjb25zdCBkYXRhID0gZXZlbnQuZGF0YTtcbiAgICAgIGlmIChkYXRhICYmIGRhdGEuc291cmNlID09PSBzUHVzaCkge1xuICAgICAgICBjb25zb2xlLmxvZyhldmVudC5kYXRhKTtcbiAgICAgICAgaWYgKGNhbGxCYWNrKSB7XG4gICAgICAgICAgY2FsbEJhY2soZGF0YS5wYXlsb2FkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xuICBwdWJsaWMgZ2VuZXJhdGVUb2tlbkZvclJlZ2lzdGVyRGV2aWNlKHN1YnNjcmlwdGlvbik6IHZvaWQge1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd0b2tlbicsIEpTT04uc3RyaW5naWZ5KHN1YnNjcmlwdGlvbikpO1xuICAgIGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZVVVSUQnKSkge1xuICAgICAgdGhpcy5nZW5lcmF0ZVVVSUQoJycpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9kZXZVVUlEID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZVVVSUQnKTtcbiAgICAgIGlmICghbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZUlkJykpIHtcbiAgICAgICAgdGhpcy5fZGV2SWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZGV2aWNlSWQnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5fcGxhdGZvcm0gPSAnJztcbiAgICB0aGlzLl9kZXZVVUlEID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZVVVSUQnKTtcbiAgICB0aGlzLl9kZXZJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdkZXZpY2VJZCcpO1xuXG4gICAgY29uc3QgcmF3S2V5ID0gc3Vic2NyaXB0aW9uLmdldEtleSA/IHN1YnNjcmlwdGlvbi5nZXRLZXkoJ3AyNTZkaCcpIDogJyc7XG4gICAgY29uc3Qga2V5ID0gcmF3S2V5XG4gICAgICA/IGJ0b2EoU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBuZXcgVWludDhBcnJheShyYXdLZXkpKSlcbiAgICAgIDogJyc7XG4gICAgY29uc3QgcmF3QXV0aFNlY3JldCA9IHN1YnNjcmlwdGlvbi5nZXRLZXlcbiAgICAgID8gc3Vic2NyaXB0aW9uLmdldEtleSgnYXV0aCcpXG4gICAgICA6ICcnO1xuICAgIGNvbnN0IGF1dGhTZWNyZXQgPSByYXdBdXRoU2VjcmV0XG4gICAgICA/IGJ0b2EoU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBuZXcgVWludDhBcnJheShyYXdBdXRoU2VjcmV0KSkpXG4gICAgICA6ICcnO1xuXG4gICAgY29uc3QgdG9rZW5WYWx1ZSA9IHtcbiAgICAgIGVuZHBvaW50OiBzdWJzY3JpcHRpb24uZW5kcG9pbnQsXG4gICAgICB1c2VyQXV0aDogYXV0aFNlY3JldCxcbiAgICAgIHVzZXJQdWJsaWNLZXk6IGtleVxuICAgIH07XG4gICAgdGhpcy5fdG9rZW4gPSBKU09OLnN0cmluZ2lmeSh0b2tlblZhbHVlKTtcbiAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94JykgIT09IC0xKSB7XG4gICAgICB0aGlzLl9wbGF0Zm9ybSA9ICdGJzsgLy8gRmlyZWZveCBCcm93c2VyXG4gICAgfSBlbHNlIGlmIChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0Nocm9tZScpICE9PSAtMSkge1xuICAgICAgdGhpcy5fcGxhdGZvcm0gPSAnQyc7IC8vIENocm9tZSBCcm93c2VyXG4gICAgfVxuXG4gICAgbGV0IGRldmljZSA9IG51bGw7XG4gICAgaWYgKHRoaXMudmFsaWRhdGVJbnB1dCh0aGlzLl9kZXZJZCkpIHtcbiAgICAgIGRldmljZSA9IHtcbiAgICAgICAgZGV2aWNlSWQ6IHRoaXMuX2RldklkLFxuICAgICAgICBwbGF0Zm9ybTogdGhpcy5fcGxhdGZvcm0sXG4gICAgICAgIHRva2VuOiB0aGlzLl90b2tlbixcbiAgICAgICAgdXVpZDogdGhpcy5fZGV2VVVJRFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGV2aWNlID0ge1xuICAgICAgICBwbGF0Zm9ybTogdGhpcy5fcGxhdGZvcm0sXG4gICAgICAgIHRva2VuOiB0aGlzLl90b2tlbixcbiAgICAgICAgdXVpZDogdGhpcy5fZGV2VVVJRFxuICAgICAgfTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RlckRldmljZShkZXZpY2UpO1xuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xuICBwdWJsaWMgcmVnaXN0ZXJEZXZpY2UoZGV2aWNlKTogdm9pZCB7XG4gICAgY29uc29sZS5sb2coJ0RldmljZSBkZXRhaWxzOicsIGRldmljZSk7XG4gICAgY29uc3QgeGhyID0gdGhpcy5zZXRSZXF1ZXN0KHRoaXMuY29uc3RhbnRzLmdldERldmljZXNQYXRoKCksICdQT1NUJywgdHJ1ZSk7XG5cbiAgICAvKnRoaXMuaHR0cC5wb3N0KHRoaXMuY29uc3RhbnRzLmdldERldmljZXNQYXRoKCksIGRldmljZSlcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnUmVzcG9uc2UgcmVnaXN0ZXIsJywgcmVzcG9uc2UpO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2RldmljZUlkJywgcmVzcG9uc2UpO1xuICAgICAgICB9KTsqL1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCAmJiB4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1Jlc3BvbnNlIHJlZ2lzdGVyLCcsIHhocik7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdkZXZpY2VJZCcsIHhoci5yZXNwb25zZVRleHQpO1xuICAgICAgfVxuICAgIH07XG4gICAgeGhyLnNlbmQoSlNPTi5zdHJpbmdpZnkoZGV2aWNlKSk7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVtYmVyLW9yZGVyaW5nXG4gIHB1YmxpYyB1blJlZ2lzdGVyRGV2aWNlKCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX2RldklkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZUlkJyk7XG4gICAgICBjb25zdCBnbG9iYWwgPSB0aGlzO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgICBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5yZWFkeVxuICAgICAgICAudGhlbihmdW5jdGlvbihyZWdpc3RyYXRpb24pIHtcbiAgICAgICAgICByZWdpc3RyYXRpb25cbiAgICAgICAgICAgIC51bnJlZ2lzdGVyKClcbiAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oY2hlY2tVbnJlZ2lzdGVyKSB7XG4gICAgICAgICAgICAgIGlmICghY2hlY2tVbnJlZ2lzdGVyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3VucmVnaXN0ZXIgZmFpbGVkJyk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGdsb2JhbFxuICAgICAgICAgICAgICAgIC51bnN1YnNjcmliZURldmljZShnbG9iYWwuX2RldklkLCBnbG9iYWwpXG4gICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdSZWdpc3RyYXRpb24gZmFpbGVkIHdpdGggJyArIGVycm9yKTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xuICBwdWJsaWMgdW5zdWJzY3JpYmVEZXZpY2UoZGV2aWNlSUQsIGdsb2JhbCk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgcHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGRldmljZUlkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2RldmljZUlkJyk7XG4gICAgICBjb25zdCBkZXZpY2UgPSB7XG4gICAgICAgIGRldmljZXM6IHtcbiAgICAgICAgICBkZXZpY2VJZDogZ2xvYmFsLl9kZXZJZCxcbiAgICAgICAgICBwbGF0Zm9ybTogZ2xvYmFsLl9wbGF0Zm9ybSxcbiAgICAgICAgICB0b2tlbjogZ2xvYmFsLl90b2tlbixcbiAgICAgICAgICB1dWlkOiBnbG9iYWwuX2RldlVVSURcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGlmIChkZXZpY2VJRCkge1xuICAgICAgICBjb25zdCB4aHIgPSBnbG9iYWwuc2V0UmVxdWVzdChcbiAgICAgICAgICBnbG9iYWwuY29uc3RhbnRzLmdldERldmljZXNQYXRoKCkgKyAnLycgKyBkZXZpY2VJRCxcbiAgICAgICAgICAnREVMRVRFJyxcbiAgICAgICAgICB0cnVlXG4gICAgICAgICk7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09PSA0ICYmIHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1RoZSByZXNwb25zZSBpcyAsJywgeGhyKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdTdWNjZXNzZnVsbHkgdW5yZWdpc3RlcmVkIHRoZSBkZXZpY2UnKTtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdkZXZpY2VVVUlEJywgJycpO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2RldmljZUlkJywgJycpO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3Rva2VuJywgJycpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgeGhyLnNlbmQoSlNPTi5zdHJpbmdpZnkoZGV2aWNlKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH1cblxuICBwcml2YXRlIHNldFJlcXVlc3QodXJsLCBtZXRob2QsIGFzeW5jUCkge1xuICAgIGxldCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICB4aHIub3BlbihtZXRob2QsIHVybCwgYXN5bmNQKTtcbiAgICB4aHIgPSB0aGlzLnNldEhlYWRlcnMoeGhyLCBtZXRob2QpO1xuICAgIHJldHVybiB4aHI7XG4gIH1cblxuICBwcml2YXRlIHNldEhlYWRlcnMoeGhyLCBtZXRob2QpIHtcbiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcigneC1pYm0tY2xpZW50LWlkJywgdGhpcy5jb25zdGFudHMuZ2V0Q2xpZW50SWQoKSk7XG4gICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0FwcC1Db2RlJywgdGhpcy5jb25zdGFudHMuZ2V0QXBwQ29kZSgpKTtcbiAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQWNjZXB0LUxhbmd1YWdlJywgdGhpcy5jb25zdGFudHMuZ2V0QXBwTGFuZ3VhZ2UoKSk7XG4gICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0F1dGhvcml6YXRpb24nLCB0aGlzLmNvbnN0YW50cy5nZXRBdXRoVG9rZW4oKSk7XG4gICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ2p3dCcsIHRoaXMuY29uc3RhbnRzLmdldEp3dCgpKTtcbiAgICB4aHIudGltZW91dCA9IDMwMDA7XG5cbiAgICBpZiAobWV0aG9kID09PSAnUE9TVCcgfHwgbWV0aG9kID09PSAnUFVUJykge1xuICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PVVURi04Jyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHhocjtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVVVUlEKHRva2VuKTogc3RyaW5nIHtcbiAgICBsZXQgZGF0ZVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICBpZiAod2luZG93LnBlcmZvcm1hbmNlICYmIHR5cGVvZiB3aW5kb3cucGVyZm9ybWFuY2Uubm93ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBkYXRlVGltZSArPSBwZXJmb3JtYW5jZS5ub3coKTsgLy8gdXNlIGhpZ2gtcHJlY2lzaW9uIHRpbWVyIGlmIGF2YWlsYWJsZVxuICAgIH1cblxuICAgIGNvbnN0IGhvc3RuYW1lID0gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lO1xuICAgIGNvbnN0IGFycmF5RGF0YSA9IFtdO1xuICAgIGFycmF5RGF0YS5wdXNoKHRoaXMuaGFzaENvZGUoZGF0ZVRpbWUpKTtcbiAgICBhcnJheURhdGEucHVzaCh0aGlzLmhhc2hDb2RlKHRva2VuKSk7XG4gICAgYXJyYXlEYXRhLnB1c2godGhpcy5oYXNoQ29kZShob3N0bmFtZSkpO1xuICAgIGFycmF5RGF0YS5wdXNoKHRoaXMuaGFzaENvZGUodGhpcy5fcGxhdGZvcm0pKTtcblxuICAgIGNvbnN0IGZpbmFsU3RyaW5nID0gYXJyYXlEYXRhXG4gICAgICAuam9pbignJylcbiAgICAgIC5yZXBsYWNlKC9bLS5dL2csICcnKVxuICAgICAgLnJlcGxhY2UoL1ssLl0vZywgJycpO1xuICAgIGxldCB1dWlkID0gJyc7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCAzMjsgaSsrKSB7XG4gICAgICB1dWlkICs9IGZpbmFsU3RyaW5nLmNoYXJBdChcbiAgICAgICAgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZmluYWxTdHJpbmcubGVuZ3RoKVxuICAgICAgKTtcbiAgICB9XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2RldmljZVVVSUQnLCB1dWlkKTtcbiAgICB0aGlzLl9kZXZVVUlEID0gdXVpZDtcbiAgICByZXR1cm4gdGhpcy5fZGV2VVVJRDtcbiAgfVxuXG4gIHByaXZhdGUgaGFzaENvZGUoc3RyKTogbnVtYmVyIHtcbiAgICBsZXQgaGFzaCA9IDA7XG4gICAgbGV0IGk7XG4gICAgbGV0IGNocjtcbiAgICBsZXQgbGVuO1xuICAgIGlmIChzdHIubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gaGFzaDtcbiAgICB9XG4gICAgZm9yIChpID0gMCwgbGVuID0gc3RyLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjaHIgPSBzdHIuY2hhckNvZGVBdChpKTtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICBoYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hyO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWJpdHdpc2VcbiAgICAgIGhhc2ggfD0gMDsgLy8gQ29udmVydCB0byAzMmJpdCBpbnRlZ2VyXG4gICAgfVxuICAgIHJldHVybiBoYXNoO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUlucHV0KHN0cmluZ1ZhbHVlKSB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgIHJldHVybiBzdHJpbmdWYWx1ZSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICBzdHJpbmdWYWx1ZSA9PSBudWxsIHx8XG4gICAgICBzdHJpbmdWYWx1ZS5sZW5ndGggPD0gMCB8fFxuICAgICAgc3RyaW5nVmFsdWUgPT09ICcnXG4gICAgICA/IGZhbHNlXG4gICAgICA6IHRydWU7XG4gIH1cblxuICBwcml2YXRlIHVybEI2NFRvVWludDhBcnJheShiYXNlNjRTdHJpbmcpIHtcbiAgICBjb25zdCBwYWRkaW5nID0gJz0nLnJlcGVhdCgoNCAtIChiYXNlNjRTdHJpbmcubGVuZ3RoICUgNCkpICUgNCk7XG4gICAgY29uc3QgYmFzZTY0ID0gKGJhc2U2NFN0cmluZyArIHBhZGRpbmcpXG4gICAgICAucmVwbGFjZSgvXFwtL2csICcrJylcbiAgICAgIC5yZXBsYWNlKC9fL2csICcvJyk7XG5cbiAgICBjb25zdCByYXdEYXRhID0gd2luZG93LmF0b2IoYmFzZTY0KTtcbiAgICBjb25zdCBvdXRwdXRBcnJheSA9IG5ldyBVaW50OEFycmF5KHJhd0RhdGEubGVuZ3RoKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmF3RGF0YS5sZW5ndGg7ICsraSkge1xuICAgICAgb3V0cHV0QXJyYXlbaV0gPSByYXdEYXRhLmNoYXJDb2RlQXQoaSk7XG4gICAgfVxuICAgIHJldHVybiBvdXRwdXRBcnJheTtcbiAgfVxufVxuIl19